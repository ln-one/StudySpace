<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StudySpace - 日历（日视图）</title>

  <style>
    :root{
      --primary:#2d81ff;
      --primary-light:#f0f7ff;
      --primary-dark:#1a6ee0;

      --success:#4cd964;
      --success-light:#e8f9eb;

      --danger:#ff3b30;
      --danger-light:#ffe6e6;

      --warning:#ff9500;

      --text-main:#1d1d1f;
      --text-secondary:#6e6e73;
      --text-tertiary:#8e8e93;

      --border:#e5e5e7;
      --border-light:#f2f2f7;

      --bg-light:#f5f5f7;
      --bg-white:#fff;
      --bg-sidebar:#f8f9fa;

      --radius-sm:6px;
      --radius-md:12px;
      --radius-lg:16px;

      --shadow-sm:0 2px 8px rgba(0,0,0,0.06);
      --shadow-lg:0 8px 24px rgba(0,0,0,0.12);

      --glass-bg:rgba(255,255,255,0.95);
      --glass-border:rgba(229,229,231,0.5);
      --glass-blur:blur(10px);
    }

    /* ====== 右侧列表：标题更大、标签更小、标签独占一行、卡片统一高度 ====== */
    .list-item{
      min-height: 124px;
      align-items: center;
    }
    .list-item__main{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .list-item__title{
      font-size:16px;
      font-weight:900;
      line-height:1.25;
      color:var(--text-main);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom:0;
    }
    .list-item__loc{
      font-size:12px;
      font-weight:800;
      color:var(--text-secondary);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .list-item__tags{
      display:flex;
      gap:8px;
      flex-wrap:nowrap;     /* 标签单独一行，不换行 */
      overflow:hidden;
    }
    .list-item__tags .pill{
      font-size:12px;
      padding:3px 10px;
      border-radius:999px;
    }

    *{
      margin:0;padding:0;box-sizing:border-box;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
    }

    html,body{width:100%;height:100%;overflow:hidden;}
    body{
      min-height:100vh;
      background:linear-gradient(135deg,#f5f7fa 0%,#e4e7ec 100%);
      color:var(--text-main);
      display:flex;
    }

    .app-container{display:flex;width:100%;height:100vh;}

    /* ===== 左侧导航（无图标） ===== */
    .sidebar{
      width:240px;height:100%;
      background:var(--bg-sidebar);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      flex-shrink:0;overflow:hidden;
    }
    .sidebar__header{
      padding:24px 20px;
      border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;
    }
    .sidebar__logo{
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,var(--primary),#4d9eff);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:18px;font-weight:800;
    }
    .sidebar__title{font-size:18px;font-weight:800;letter-spacing:-0.5px;}
    .sidebar__nav{padding:24px 0;flex:1;display:flex;flex-direction:column;gap:4px;}
    .sidebar__nav-item{
      display:flex;align-items:center;
      padding:14px 20px;
      text-decoration:none;
      color:var(--text-secondary);
      transition:all .2s;
      font-size:15px;font-weight:600;
      border-left:3px solid transparent;
    }
    .sidebar__nav-item:hover{background:var(--bg-light);color:var(--text-main);}
    .sidebar__nav-item.active{
      background:var(--primary-light);
      color:var(--primary);
      border-left-color:var(--primary);
      font-weight:800;
    }
    .sidebar__footer{
      padding:20px;border-top:1px solid var(--border);
      display:flex;align-items:center;gap:12px;
    }
    .sidebar__avatar{
      width:36px;height:36px;border-radius:50%;
      background:linear-gradient(135deg,var(--primary),#4d9eff);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:14px;font-weight:800;
      flex-shrink:0;
    }
    .sidebar__user-name{
      font-size:14px;font-weight:800;color:var(--text-main);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .sidebar__user-id{font-size:12px;color:var(--text-tertiary);}

    /* ===== 主内容 ===== */
    .main-content{
      flex:1;display:flex;flex-direction:column;
      overflow:hidden;padding:24px;gap:24px;
      min-width:0;
    }

    .page-header{
      background:var(--bg-white);
      border-radius:var(--radius-lg);
      padding:20px 24px;
      box-shadow:var(--shadow-sm);
      border:1px solid var(--border);
    }
    .page-header__top{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;margin-bottom:16px;
    }
    .page-title{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:900;letter-spacing:-0.4px;}
    .page-title .dot{
      width:10px;height:10px;border-radius:50%;background:var(--primary);
      box-shadow:0 0 0 6px rgba(45,129,255,0.12);
    }

    .header-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;}
    .btn{
      height:42px;padding:0 14px;border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:var(--bg-white);
      color:var(--text-main);
      font-size:14px;font-weight:800;
      cursor:pointer;transition:all .2s;user-select:none;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .btn:hover{background:var(--bg-light);border-color:rgba(45,129,255,0.35);}
    .btn-primary{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:#fff;border-color:transparent;
      box-shadow:0 10px 28px rgba(45,129,255,0.18);
    }
    .btn-primary:hover{transform:translateY(-1px);}

    .date-chip{
      height:42px;padding:0 14px;min-width:240px;
      display:flex;align-items:center;justify-content:center;gap:10px;
      border-radius:var(--radius-md);
      background:var(--bg-light);
      border:1px solid var(--border);
      font-weight:900;letter-spacing:-0.2px;
    }
    .date-chip small{font-weight:800;color:var(--text-secondary);}

    /* ✅ 视图切换：支持跳转 */
    .view-tabs{
      display:flex;gap:6px;padding:4px;
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:var(--radius-md);
    }
    .view-tab{
      height:34px;padding:0 12px;
      border:none;border-radius:var(--radius-sm);
      background:transparent;color:var(--text-secondary);
      font-weight:900;cursor:pointer;transition:all .2s;font-size:13px;
    }
    .view-tab:hover{background:var(--bg-white);}
    .view-tab.active{background:var(--primary);color:#fff;}

    .page-header__bottom{
      display:flex;align-items:center;gap:16px;flex-wrap:wrap;
      justify-content:space-between;
    }
    .search-box{
      flex:1;min-width:280px;
      display:flex;align-items:center;gap:10px;
      padding:0 12px;height:44px;border-radius:var(--radius-md);
      border:1px solid var(--border);background:var(--bg-white);
      transition:all .2s;
    }
    .search-box:focus-within{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(45,129,255,0.12);
    }
    .search-box input{
      border:none;outline:none;width:100%;
      font-size:14px;font-weight:700;color:var(--text-main);
      background:transparent;
    }
    .search-box .kbd{
      font-size:12px;font-weight:900;color:var(--text-tertiary);
      border:1px solid var(--border);border-bottom-width:2px;
      padding:4px 8px;border-radius:10px;background:var(--bg-light);
      white-space:nowrap;
    }
    .select{
      height:42px;padding:0 14px;border-radius:var(--radius-md);
      border:1px solid var(--border);
      background:var(--bg-white);
      font-size:14px;font-weight:800;color:var(--text-main);
      cursor:pointer;transition:all .2s;
    }
    .select:focus{
      outline:none;border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(45,129,255,0.12);
    }

    /* ===== 日历布局 ===== */
    .calendar-shell{flex:1;min-height:0;display:flex;gap:24px;overflow:hidden;}
    .calendar-board{
      flex:1;min-width:0;min-height:0;
      background:var(--bg-white);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      border:1px solid var(--border);
      overflow:hidden;
      display:flex;flex-direction:column;
    }

    .board-head{
      padding:16px 18px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:linear-gradient(180deg,#fff 0%, #fbfbfd 100%);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background:var(--primary-light);color:var(--primary);
      border:1px solid rgba(45,129,255,0.25);
      font-size:13px;font-weight:900;white-space:nowrap;
    }
    .timezone{font-size:13px;color:var(--text-tertiary);font-weight:800;white-space:nowrap;}

    .day-grid{
      flex:1;min-height:0;
      overflow:auto;position:relative;
      display:grid;
      grid-template-columns:72px 1fr;
      background:var(--bg-white);
    }
    .day-grid::-webkit-scrollbar{width:8px;}
    .day-grid::-webkit-scrollbar-track{background:var(--bg-light);border-radius:4px;}
    .day-grid::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}
    .day-grid::-webkit-scrollbar-thumb:hover{background:var(--text-tertiary);}

    .time-col{
      border-right:1px solid var(--border);
      background:linear-gradient(180deg,#fff 0%, #fbfbfd 100%);
      position:sticky;left:0;z-index:5;
    }
    .time-slot{
      height:56px;
      border-bottom:1px solid var(--border-light);
      display:flex;align-items:flex-start;justify-content:flex-end;
      padding:10px 10px 0 0;
      font-size:12px;font-weight:900;color:var(--text-tertiary);
      letter-spacing:0.2px;
    }
    .canvas{position:relative;}
    .canvas-row{
      height:56px;
      border-bottom:1px solid var(--border-light);
      position:relative;
    }
    .canvas-row:hover{background:rgba(45,129,255,0.04);}

    .now-line{
      position:absolute;left:0;right:0;height:2px;
      background:var(--danger);
      box-shadow:0 6px 20px rgba(255,59,48,0.18);
      z-index:10;
    }
    .now-dot{
      position:absolute;left:12px;width:10px;height:10px;border-radius:50%;
      background:var(--danger);
      transform:translate(-50%,-50%);top:50%;
      box-shadow:0 0 0 6px rgba(255,59,48,0.12);
    }

    /* ===== 事件块（高度/换行/不裁切） ===== */
    .event{
      position:absolute;left:16px;right:16px;
      border-radius:14px;
      border:1px solid rgba(45,129,255,0.22);
      background:linear-gradient(135deg, rgba(45,129,255,0.14), rgba(77,158,255,0.10));
      box-shadow:0 10px 26px rgba(45,129,255,0.10);
      padding: 16px 16px 22px;
      cursor:pointer;
      transition:transform .15s, box-shadow .2s, border-color .2s;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .event:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 32px rgba(45,129,255,0.14);
      border-color:rgba(45,129,255,0.35);
    }
    .event::before{
      content:"";
      position:absolute;inset:0;
      background:rgba(45,129,255,0.06);
      pointer-events:none;
    }
    .event__title{
      font-size:14px;font-weight:900;color:var(--text-main);
      white-space:normal;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    .event__meta{
      display:flex;gap:8px;flex-wrap:wrap;
      font-size:12px;font-weight:800;color:var(--text-secondary);
      overflow:hidden;
    }
    .pill{
      display:inline-flex;align-items:center;
      padding:4px 10px;border-radius:999px;
      background:var(--bg-white);
      border:1px solid var(--border);
      color:var(--text-secondary);
      font-weight:900;
      white-space:nowrap;
    }
    .event--focus{
      background:linear-gradient(135deg, rgba(76,217,100,0.16), rgba(76,217,100,0.10));
      border-color:rgba(76,217,100,0.30);
      box-shadow:0 10px 26px rgba(76,217,100,0.10);
    }
    .event--warn{
      background:linear-gradient(135deg, rgba(255,149,0,0.18), rgba(255,149,0,0.10));
      border-color:rgba(255,149,0,0.35);
      box-shadow:0 10px 26px rgba(255,149,0,0.10);
    }
    .event--danger{
      background:linear-gradient(135deg, rgba(255,59,48,0.16), rgba(255,59,48,0.08));
      border-color:rgba(255,59,48,0.30);
      box-shadow:0 10px 26px rgba(255,59,48,0.10);
    }

    /* ===== 右侧面板 ===== */
    .side-panel{
      width:360px;flex-shrink:0;min-height:0;
      background:var(--bg-white);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-sm);
      overflow:hidden;
      display:flex;flex-direction:column;
    }
    .side-panel__head{
      padding:18px 18px 14px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#fff 0%, #fbfbfd 100%);
    }
    .side-panel__title{font-size:18px;font-weight:900;letter-spacing:-0.3px;margin-bottom:6px;}
    .side-panel__sub{font-size:13px;color:var(--text-secondary);font-weight:700;}
    .side-panel__body{padding:16px 18px 18px;overflow:auto;min-height:0;}
    .card{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      padding:16px;margin-bottom:14px;
    }
    .kv{margin-bottom:12px;}
    .kv:last-child{margin-bottom:0;}
    .kv__k{
      font-size:12px;color:var(--text-secondary);
      font-weight:900;text-transform:uppercase;
      letter-spacing:0.6px;margin-bottom:6px;
    }
    .kv__v{font-size:14px;font-weight:900;color:var(--text-main);display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .list{display:flex;flex-direction:column;gap:10px;}
    .list-item{
      background:var(--bg-white);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:flex;gap:10px;align-items:flex-start;
      cursor:pointer;transition:all .2s;
    }
    .list-item:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-sm);
      border-color:rgba(45,129,255,0.28);
    }
    .time-tag{
      min-width:74px;text-align:center;
      padding:8px 10px;border-radius:12px;
      background:var(--primary-light);
      color:var(--primary);
      border:1px solid rgba(45,129,255,0.22);
      font-weight:900;font-size:12px;line-height:1.1;
      align-self:center;
    }
    .time-tag small{display:block;margin-top:4px;color:var(--text-secondary);font-weight:900;}
    .side-panel__footer{
      padding:14px 18px 18px;border-top:1px solid var(--border);
      display:flex;gap:10px;
    }
    .side-panel__footer .btn{flex:1;}

    /* ===== Modal ===== */
    .modal{
      position:fixed;inset:0;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.14);
      backdrop-filter:var(--glass-blur);
      -webkit-backdrop-filter:var(--glass-blur);
      z-index:2000;
      padding:18px;
    }
    .modal.active{display:flex;}
    .modal__body{
      background:var(--bg-white);
      border-radius:var(--radius-lg);
      padding:22px 24px;
      border:1px solid var(--glass-border);
      box-shadow:var(--shadow-lg);
      width:min(520px,94vw);
    }
    .modal__title{font-size:18px;font-weight:900;margin-bottom:10px;letter-spacing:-0.2px;}
    .modal__msg{font-size:14px;font-weight:700;color:var(--text-secondary);line-height:1.6;white-space:pre-line;margin-bottom:16px;display:none;}
    .modal__actions{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .form-grid.single{grid-template-columns:1fr;}
    .form-row{display:flex;flex-direction:column;gap:6px;}
    .form-row label{font-size:13px;font-weight:800;color:var(--text-secondary);}
    .form-row input,.form-row select{height:40px;padding:0 12px;border-radius:10px;border:1px solid var(--border);background:var(--bg-white);font-size:14px;font-weight:700;}
    .tag-options{display:flex;flex-wrap:wrap;gap:8px;}
    .tag-option{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--bg-light);font-size:13px;font-weight:800;cursor:pointer;}
    .tag-option input{accent-color:var(--primary);}
    @keyframes fadeIn{
      from{opacity:0; transform:translate(-50%,-54%);}
      to{opacity:1; transform:translate(-50%,-50%);}
    }

    @media (max-width: 1100px){
      .side-panel{display:none;}
    }
  </style>
</head>

<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar__header">
        <div class="sidebar__logo">S</div>
        <div class="sidebar__title">StudySpace</div>
      </div>
      <nav class="sidebar__nav">
        <a href="桌面端-用户端-任务.html" class="sidebar__nav-item">任务</a>
        <a href="calendar_day.html" class="sidebar__nav-item active">日历</a>
        <a href="桌面端-用户端-学习记录.html" class="sidebar__nav-item">学习记录</a>
        <a href="桌面-用户端-座位预约.html" class="sidebar__nav-item">座位预约</a>
        <a href="桌面端-用户端-设置.html" class="sidebar__nav-item">个人设置</a>

      </nav>
      <div class="sidebar__footer">
        <div class="sidebar__avatar">用</div>
        <div>
          <div class="sidebar__user-name">StudyUser123</div>
          <div class="sidebar__user-id">ID: 887654321</div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <section class="page-header">
        <div class="page-header__top">
          <div class="page-title">
            <span class="dot"></span>
            <span>日历（日视图）</span>
          </div>

          <div class="header-actions">
            <button class="btn" id="prevDayBtn">上一天</button>
            <div class="date-chip" id="dateChip">
              <span id="dateChipMain">2025/12/14</span>
              <small id="dateChipWeek">周日</small>
            </div>
            <button class="btn" id="nextDayBtn">下一天</button>

            <div class="view-tabs" aria-label="视图切换">
              <button class="view-tab active" data-view="day" type="button">日</button>
              <button class="view-tab" data-view="week" type="button">周</button>
              <button class="view-tab" data-view="month" type="button">月</button>
            </div>

            <button class="btn btn-primary" id="newEventBtn">新建日程</button>
          </div>
        </div>

        <div class="page-header__bottom">
          <div class="search-box" title="搜索日程">
            <input id="searchInput" placeholder="搜索：标题 / 地点 / 标签…" />
            <span class="kbd">Ctrl K</span>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
            <select class="select" id="calendarSelect" title="日历来源">
              <option value="all" selected>全部日历</option>
              <option value="study">学习计划</option>
              <option value="seat">座位预约</option>
              <option value="life">个人事务</option>
            </select>

            <select class="select" id="densitySelect" title="密度">
              <option value="comfortable" selected>舒适</option>
              <option value="compact">紧凑</option>
            </select>

            <button class="btn" id="todayBtn">回到今天</button>
          </div>
        </div>
      </section>

      <section class="calendar-shell">
        <div class="calendar-board">
          <div class="board-head">
            <div style="display:flex;align-items:center;gap:10px;min-width:0;">
              <span class="badge" id="summaryBadge">今日 3 个日程</span>
              <span class="timezone">时区：Asia/Tokyo</span>
            </div>
            <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
              <button class="btn" id="scrollNowBtn">定位当前时间</button>
            </div>
          </div>

          <div class="day-grid" id="dayGrid">
            <div class="time-col" id="timeCol"></div>
            <div class="canvas" id="canvas"></div>

            <div class="now-line" id="nowLine" style="display:none;">
              <span class="now-dot"></span>
            </div>
          </div>
        </div>

        <aside class="side-panel">
          <div class="side-panel__head">
            <div class="side-panel__title" id="panelTitle">当天事项</div>
            <div class="side-panel__sub" id="panelSub">点击左侧事件查看详情</div>
          </div>

          <div class="side-panel__body">
            <div class="card" id="detailCard">
              <div class="kv">
                <div class="kv__k">标题</div>
                <div class="kv__v" id="dTitle">—</div>
              </div>
              <div class="kv">
                <div class="kv__k">时间</div>
                <div class="kv__v" id="dTime">—</div>
              </div>
              <div class="kv">
                <div class="kv__k">地点</div>
                <div class="kv__v" id="dLoc">—</div>
              </div>
              <div class="kv">
                <div class="kv__k">标签</div>
                <div class="kv__v" id="dTags"><span class="pill">—</span></div>
              </div>
            </div>

            <div class="kv" style="margin: 10px 0 8px;">
              <div class="kv__k">日程列表</div>
            </div>

            <div class="list" id="agendaList"></div>
          </div>

          <div class="side-panel__footer">
            <button class="btn" id="editBtn" disabled>编辑</button>
            <button class="btn" id="deleteBtn" disabled style="border-color: rgba(255,59,48,0.35); color: var(--danger);">删除</button>
          </div>
        </aside>
      </section>
    </main>

    <div class="modal" id="modal">
      <div class="modal__body">
        <div class="modal__title" id="modalTitle">提示</div>
        <div class="modal__msg" id="modalMsg">—</div>

        <div id="modalForm">
          <div class="form-grid">
            <div class="form-row">
              <label for="eventTitle">标题</label>
              <input id="eventTitle" placeholder="如：自习 · 英语听力训练" />
            </div>
            <div class="form-row">
              <label for="eventDate">日期</label>
              <input id="eventDate" type="date" />
            </div>
            <div class="form-row">
              <label for="eventStart">开始时间</label>
              <input id="eventStart" type="time" />
            </div>
            <div class="form-row">
              <label for="eventEnd">结束时间</label>
              <input id="eventEnd" type="time" />
            </div>
          </div>
          <div class="form-grid single" style="margin-top:10px;">
            <div class="form-row">
              <label for="eventLoc">地点</label>
              <input id="eventLoc" placeholder="如：自习室 · A区 / 线上" />
            </div>
          </div>
          <div class="form-row" style="margin-top:10px;">
            <label>标签</label>
            <div class="tag-options" id="tagOptions">
              <label class="tag-option"><input type="checkbox" value="学习计划"> 学习计划</label>
              <label class="tag-option"><input type="checkbox" value="座位预约"> 座位预约</label>
              <label class="tag-option"><input type="checkbox" value="个人事务"> 个人事务</label>
              <label class="tag-option"><input type="checkbox" value="讨论"> 讨论</label>
              <label class="tag-option"><input type="checkbox" value="复盘"> 复盘</label>
              <label class="tag-option"><input type="checkbox" value="专注"> 专注</label>
            </div>
          </div>
        </div>

        <div class="modal__actions">
          <button class="btn" id="modalCancel">取消</button>
          <button class="btn btn-primary" id="modalOk">确定</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========= 示例数据（日视图按当天展示） ========= */
    let events = [
      {
        id: "e1",
        title: "英语听力训练",
        start: "09:00",
        end: "10:20",
        location: "自习室 · A区",
        tags: ["学习计划", "专注"],
        tone: "focus"
      },
      {
        id: "e2",
        title: "座位预约：B12（确认入座）",
        start: "13:00",
        end: "15:00",
        location: "2楼 · 区域B",
        tags: ["座位预约"],
        tone: "warn"
      },
      {
        id: "e3",
        title: "任务复盘 & 明日计划",
        start: "20:00",
        end: "20:45",
        location: "线上",
        tags: ["任务", "复盘"],
        tone: "normal"
      }
    ];

    /* ========= 工具 ========= */
    const pad2 = n => String(n).padStart(2, "0");
    const weekCN = ["周日","周一","周二","周三","周四","周五","周六"];

    function formatDateCN(d){
      return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
    }
    function toISODate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function timeToMinutes(t){
      const [h,m] = t.split(":").map(Number);
      return h*60 + m;
    }
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[s]));
    }

    /* ========= 读取 URL date 参数作为初始日期 ========= */
    function getQueryDate(){
      const p = new URLSearchParams(location.search);
      const s = p.get("date");
      if(!s) return null;
      // 期望 YYYY-MM-DD
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(s);
      if(!m) return null;
      const d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
      if (Number.isNaN(d.getTime())) return null;
      return d;
    }
    function setQueryDate(d){
      const p = new URLSearchParams(location.search);
      p.set("date", toISODate(d));
      const newUrl = `${location.pathname}?${p.toString()}`;
      history.replaceState(null, "", newUrl);
    }

    /* ========= 视图跳转（把 date 带过去） ========= */
    function goToView(view){
      const dateStr = toISODate(currentDate);
      if(view === "day")  location.href = `calendar_day.html?date=${encodeURIComponent(dateStr)}`;
      if(view === "week") location.href = `calendar_week.html?date=${encodeURIComponent(dateStr)}`;
      if(view === "month")location.href = `calendar_month.html?date=${encodeURIComponent(dateStr)}`;
    }

    /* ========= DOM ========= */
    const dateChipMain = document.getElementById("dateChipMain");
    const dateChipWeek = document.getElementById("dateChipWeek");
    const summaryBadge = document.getElementById("summaryBadge");

    const timeCol = document.getElementById("timeCol");
    const canvas = document.getElementById("canvas");
    const dayGrid = document.getElementById("dayGrid");
    const nowLine = document.getElementById("nowLine");

    const agendaList = document.getElementById("agendaList");

    const dTitle = document.getElementById("dTitle");
    const dTime = document.getElementById("dTime");
    const dLoc = document.getElementById("dLoc");
    const dTags = document.getElementById("dTags");

    const editBtn = document.getElementById("editBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    const searchInput = document.getElementById("searchInput");
    const calendarSelect = document.getElementById("calendarSelect");
    const densitySelect = document.getElementById("densitySelect");

    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modalTitle");
    const modalMsg = document.getElementById("modalMsg");
    const modalCancel = document.getElementById("modalCancel");
    const modalOk = document.getElementById("modalOk");
    const modalForm = document.getElementById("modalForm");
    const inputTitle = document.getElementById("eventTitle");
    const inputDate = document.getElementById("eventDate");
    const inputStart = document.getElementById("eventStart");
    const inputEnd = document.getElementById("eventEnd");
    const inputLoc = document.getElementById("eventLoc");
    const tagOptions = document.querySelectorAll('#tagOptions input[type="checkbox"]');

    /* ========= 状态 ========= */
    let currentDate = getQueryDate() || new Date();
    let selectedEventId = null;
    let ROW_HEIGHT = 56; // 1小时对应像素高度

    /* 事件：根据时长分段最小高度 */
    function minHeightByDuration(durMinutes){
      if (durMinutes < 90) return 90;
      if (durMinutes < 110) return 110;
      return 64;
    }

    /* ========= 网格 ========= */
    function renderGrid(){
      timeCol.innerHTML = "";
      canvas.innerHTML = "";

      for(let h=0; h<24; h++){
        const t = document.createElement("div");
        t.className = "time-slot";
        t.style.height = ROW_HEIGHT + "px";
        t.textContent = `${pad2(h)}:00`;
        timeCol.appendChild(t);

        const r = document.createElement("div");
        r.className = "canvas-row";
        r.style.height = ROW_HEIGHT + "px";
        canvas.appendChild(r);
      }
    }

    /* ========= 事件渲染 ========= */
    function toneClass(tone){
      if(tone === "focus") return "event--focus";
      if(tone === "warn") return "event--warn";
      if(tone === "danger") return "event--danger";
      return "";
    }

    function renderEvents(filtered){
      canvas.querySelectorAll(".event").forEach(n => n.remove());

      filtered.forEach(ev => {
        const startMin = timeToMinutes(ev.start);
        const endMin = timeToMinutes(ev.end);
        const dur = Math.max(10, endMin - startMin);

        const top = (startMin / 60) * ROW_HEIGHT + 6;

        const proportional = (dur / 60) * ROW_HEIGHT - 10;
        const minH = minHeightByDuration(dur);
        const height = Math.max(minH, proportional);

        const el = document.createElement("div");
        el.className = `event ${toneClass(ev.tone)}`;
        el.style.top = `${top}px`;
        el.style.height = `${height}px`;
        el.dataset.id = ev.id;

        el.innerHTML = `
          <div class="event__title">${escapeHtml(ev.title)}</div>
          <div class="event__meta">
            <span class="pill">${ev.start} - ${ev.end}</span>
            <span class="pill">${escapeHtml(ev.location || "未填写地点")}</span>
            ${(ev.tags || []).slice(0, 3).map(t => `<span class="pill">${escapeHtml(t)}</span>`).join("")}
          </div>
        `;
        el.addEventListener("click", () => selectEvent(ev.id));
        canvas.appendChild(el);
      });

      summaryBadge.textContent = `今日 ${filtered.length} 个日程`;
    }

    /* ========= 右侧列表 ========= */
    function renderAgendaList(filtered){
      agendaList.innerHTML = "";
      const sorted = [...filtered].sort((a,b)=>timeToMinutes(a.start)-timeToMinutes(b.start));

      sorted.forEach(ev => {
        const item = document.createElement("div");
        item.className = "list-item";
        item.dataset.id = ev.id;
        item.innerHTML = `
          <div class="time-tag">${ev.start}<small>${ev.end}</small></div>
          <div class="list-item__main">
            <div class="list-item__title">${escapeHtml(ev.title)}</div>
            <div class="list-item__loc">${escapeHtml(ev.location || "未填写地点")}</div>
            <div class="list-item__tags">
              ${(ev.tags||[]).slice(0,3).map(t=>`<span class="pill">${escapeHtml(t)}</span>`).join("")}
            </div>
          </div>
        `;
        item.addEventListener("click", () => selectEvent(ev.id));
        agendaList.appendChild(item);
      });
    }

    function selectEvent(id){
      selectedEventId = id;
      const ev = events.find(e => e.id === id);
      if(!ev) return;

      dTitle.textContent = ev.title;
      dTime.textContent = `${formatDateCN(currentDate)}  ${ev.start} - ${ev.end}`;
      dLoc.textContent = ev.location || "—";

      dTags.innerHTML = "";
      (ev.tags && ev.tags.length ? ev.tags : ["—"]).forEach(t=>{
        const p = document.createElement("span");
        p.className = "pill";
        p.textContent = t;
        dTags.appendChild(p);
      });

      [...agendaList.querySelectorAll(".list-item")].forEach(n=>{
        n.style.borderColor = n.dataset.id === id ? "rgba(45,129,255,0.45)" : "var(--border)";
      });

      editBtn.disabled = false;
      deleteBtn.disabled = false;
    }

    /* ========= 当前时间线（仅当天显示） ========= */
    function renderNowLine(){
      const today = new Date();
      const sameDay = today.toDateString() === currentDate.toDateString();
      if(!sameDay){
        nowLine.style.display = "none";
        return;
      }
      const minutes = today.getHours()*60 + today.getMinutes();
      const top = (minutes / 60) * ROW_HEIGHT;
      nowLine.style.display = "block";
      nowLine.style.top = `${top}px`;
    }

    function scrollToNow(){
      const today = new Date();
      const minutes = today.getHours()*60 + today.getMinutes();
      const top = (minutes / 60) * ROW_HEIGHT;
      const target = top - dayGrid.clientHeight * 0.35;
      dayGrid.scrollTop = clamp(target, 0, dayGrid.scrollHeight);
    }

    /* ========= 顶部日期 ========= */
    function updateDateHeader(){
      dateChipMain.textContent = formatDateCN(currentDate);
      dateChipWeek.textContent = weekCN[currentDate.getDay()];
    }

    function shiftDay(delta){
      currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate()+delta);
      setQueryDate(currentDate);

      selectedEventId = null;
      editBtn.disabled = true;
      deleteBtn.disabled = true;
      dTitle.textContent = "—";
      dTime.textContent = "—";
      dLoc.textContent = "—";
      dTags.innerHTML = `<span class="pill">—</span>`;

      rerender();
      // 如果切回今天，自动稍微定位一下
      if(new Date().toDateString() === currentDate.toDateString()){
        setTimeout(scrollToNow, 50);
      }
    }

    function setToday(){
      currentDate = new Date();
      setQueryDate(currentDate);
      rerender();
      setTimeout(scrollToNow, 50);
    }

    /* ========= 过滤 ========= */
    function filterEvents(){
      const q = (searchInput.value || "").trim().toLowerCase();
      const source = calendarSelect.value;
      const dateStr = toISODate(currentDate);

      return events.filter(ev => {
        if(ev.date && ev.date !== dateStr) return false;
        if(source !== "all"){
          const tagMap = { study:"学习计划", seat:"座位预约", life:"个人事务" };
          const must = tagMap[source];
          if(must && !(ev.tags||[]).includes(must)) return false;
        }

        if(!q) return true;
        const blob = `${ev.title} ${ev.location||""} ${(ev.tags||[]).join(" ")}`.toLowerCase();
        return blob.includes(q);
      });
    }

    function applyDensity(){
      const d = densitySelect.value;
      ROW_HEIGHT = d === "compact" ? 48 : 56;
      rerender();
      setTimeout(renderNowLine, 10);
    }

    /* ========= 渲染总控 ========= */
    function rerender(){
      updateDateHeader();
      renderGrid();
      const filtered = filterEvents();
      renderEvents(filtered);
      renderAgendaList(filtered);
      renderNowLine();
    }

    /* ========= Modal ========= */
    let modalOkHandler = null;
    let modalMode = "create";
    let editingId = null;

    function resetForm(){
      modalMsg.style.display = "none";
      modalForm.style.display = "block";
      inputTitle.value = "";
      inputDate.value = toISODate(currentDate);
      inputStart.value = "";
      inputEnd.value = "";
      inputLoc.value = "";
      tagOptions.forEach(cb=>cb.checked=false);
    }

    function openEventForm(mode, ev){
      modalMode = mode;
      editingId = ev?.id || null;
      resetForm();
      modalTitle.textContent = mode === "edit" ? "编辑日程" : "新建日程";
      modalOk.textContent = mode === "edit" ? "保存修改" : "保存日程";
      if(ev){
        inputTitle.value = ev.title || "";
        inputStart.value = ev.start || "";
        inputEnd.value = ev.end || "";
        inputLoc.value = ev.location || "";
        inputDate.value = ev.date || toISODate(currentDate);
        tagOptions.forEach(cb=>cb.checked = (ev.tags||[]).includes(cb.value));
      }
      modal.classList.add("active");
      modalOkHandler = handleSubmitForm;
    }

    function showConfirm(title, msg, onOk){
      modalTitle.textContent = title;
      modalMsg.textContent = msg;
      modalMsg.style.display = "block";
      modalForm.style.display = "none";
      modalOk.textContent = "确定";
      modal.classList.add("active");
      modalOkHandler = onOk || null;
    }

    function closeModal(){
      modal.classList.remove("active");
      modalOkHandler = null;
      editingId = null;
    }

    function handleSubmitForm(){
      const title = inputTitle.value.trim();
      const date = inputDate.value || toISODate(currentDate);
      const start = inputStart.value || "";
      const end = inputEnd.value || "";
      if(!title){ alert("请填写标题"); return; }
      if(start && end && timeToMinutes(end) < timeToMinutes(start)){ alert("结束时间需晚于开始时间"); return; }
      const payload = {
        id: editingId || `e${Date.now()}`,
        title,
        date,
        start,
        end,
        location: inputLoc.value.trim(),
        tags: Array.from(tagOptions).filter(cb=>cb.checked).map(cb=>cb.value),
        tone: "normal"
      };
      if(modalMode === "edit"){
        events = events.map(ev => ev.id === editingId ? { ...ev, ...payload } : ev);
        selectedEventId = payload.id;
      }else{
        events.push(payload);
        selectedEventId = payload.id;
      }
      closeModal();
      rerender();
    }

    /* ========= 绑定 ========= */
    document.getElementById("prevDayBtn").addEventListener("click", ()=>shiftDay(-1));
    document.getElementById("nextDayBtn").addEventListener("click", ()=>shiftDay(1));
    document.getElementById("todayBtn").addEventListener("click", setToday);
    document.getElementById("scrollNowBtn").addEventListener("click", scrollToNow);

    document.getElementById("newEventBtn").addEventListener("click", ()=>openEventForm("create"));

    editBtn.addEventListener("click", ()=>{
      const ev = events.find(e => e.id === selectedEventId);
      if(!ev) return;
      openEventForm("edit", ev);
    });

    deleteBtn.addEventListener("click", ()=>{
      const ev = events.find(e => e.id === selectedEventId);
      if(!ev) return;
      showConfirm("删除确认",
        `确认删除该日程？\n\n${ev.title}\n${ev.start}-${ev.end}`,
        ()=>{
          events = events.filter(e => e.id !== selectedEventId);
          selectedEventId = null;
          closeModal();
          rerender();
          editBtn.disabled = true;
          deleteBtn.disabled = true;
          dTitle.textContent = "—";
          dTime.textContent = "—";
          dLoc.textContent = "—";
          dTags.innerHTML = `<span class="pill">—</span>`;
        }
      );
    });

    modalCancel.addEventListener("click", closeModal);
    modalOk.addEventListener("click", ()=>{
      // 如果当前展示的是表单，优先执行提交逻辑，避免因回调丢失导致按钮无响应
      if(modalForm.style.display !== "none") {
        handleSubmitForm();
        return;
      }
      if(typeof modalOkHandler === "function") modalOkHandler();
      else closeModal();
    });

    searchInput.addEventListener("input", rerender);
    calendarSelect.addEventListener("change", rerender);
    densitySelect.addEventListener("change", applyDensity);

    /* ✅ 视图切换：跳转周/月（并携带 date） */
    document.querySelectorAll(".view-tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const v = btn.dataset.view;
        if(v === "day") return;
        goToView(v);
      });
    });

    document.addEventListener("keydown", (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="k"){
        e.preventDefault();
        searchInput.focus();
      }
    });

    setInterval(renderNowLine, 60*1000);

    /* 初始化 */
    (function init(){
      setQueryDate(currentDate);
      rerender();
      if(new Date().toDateString() === currentDate.toDateString()){
        setTimeout(scrollToNow, 80);
      }
    })();
  </script>
</body>
</html>